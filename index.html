<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SandÄ±k SayacÄ± + Ã‡izgi ÅžemasÄ±</title>
<style>
  body {
    background: #0d1117;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    flex-direction: column;
    position: relative;
  }

  #countdown {
    font-size: 4em;
    font-weight: bold;
  }

  #message {
    margin-top: 10px;
    color: #aaa;
    font-size: 1rem;
  }

  #edgeBox {
    margin-top: 25px;
    padding: 15px 25px;
    background: black;
    border-radius: 15px;
    display: none;
    font-size: 1.6em;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.05s ease;
    border: 2px solid red;
  }

  #edgeValue {
    color: white;
  }

  #earlyText {
    margin-top: 40px;
    font-size: 0.9rem;
    padding: 5px 8px;
    border: 2px solid red;
    border-radius: 5px;
  }

  #overlay {
    position: absolute;
    top: 0;
    left: 0;
  }
</style>
</head>
<body>

<div id="countdown">--:--:---</div>
<div id="message">SandÄ±k aÃ§Ä±lmasÄ±na kalan sÃ¼re</div>

<div id="edgeBox">
  <span id="edgeValue">-- ms</span>
</div>

<div id="earlyText">Erken aÃ§Ä±lmasÄ± gereken sÃ¼re</div>

<svg id="overlay"></svg>

<script>
const params = new URLSearchParams(window.location.search);

const timestampParam = Number(params.get("timestamp"));
const unpackAtParam = Number(params.get("unpack_at"));
const edgeParam = params.get("edge");

const cd = document.getElementById("countdown");
const msg = document.getElementById("message");
const edgeBox = document.getElementById("edgeBox");
const edgeValue = document.getElementById("edgeValue");
const earlyText = document.getElementById("earlyText");
const overlay = document.getElementById("overlay");

if (!timestampParam || !unpackAtParam) {
    cd.textContent = "âŒ Eksik parametre!";
    msg.textContent = "timestamp ve unpack_at parametreleri gerekli!";
    throw new Error("Eksik parametreler!");
}

history.replaceState({}, document.title, window.location.pathname);

function measureEdgeGidisImage(ip, timeout = 1800) {
    return new Promise(resolve => {
        const img = new Image();
        const url = "https://" + ip + "/probe.png?cb=" + Math.random();
        const start = performance.now();
        let ended = false;
        const end = () => {
            if (ended) return;
            ended = true;
            resolve(performance.now() - start);
        };
        img.onload = end;
        img.onerror = end;
        img.src = url;
        setTimeout(end, timeout);
    });
}

let edgeMs = null;
const leadTime = 120;
let flashDone = false;

if (edgeParam) {
    (async () => {
        const ip = edgeParam.replace(":443", "");
        const measured = await measureEdgeGidisImage(ip, 1800);
        edgeMs = measured;
        edgeValue.textContent = `${Math.round(edgeMs)} ms`;
        edgeBox.style.display = "flex";
        drawOverlay();
    })();
}

const unpackAtMs = unpackAtParam * 1000;

function triggerSingleFlash() {
    edgeBox.style.background = "#ff0000";
    edgeBox.style.boxShadow = "0 0 25px 20px #ff0000";
    edgeBox.style.transform = "scale(1.2)";
    setTimeout(() => {
        edgeBox.style.background = "black";
        edgeBox.style.boxShadow = "none";
        edgeBox.style.transform = "scale(1)";
    }, 100);
}

function drawOverlay() {
    overlay.innerHTML = "";
    overlay.setAttribute("width", window.innerWidth);
    overlay.setAttribute("height", window.innerHeight);

    const earlyRect = earlyText.getBoundingClientRect();
    const edgeRect = edgeBox.getBoundingClientRect();

    // EarlyText â†’ Orta kutu baÄŸlantÄ±sÄ± (tek Ã§izgi kaldÄ±)
    const startX = earlyRect.left + earlyRect.width/2;
    const startY = earlyRect.top;
    const endX = edgeRect.left + edgeRect.width/2;
    const endY = edgeRect.top + edgeRect.height;

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", startX);
    line.setAttribute("y1", startY);
    line.setAttribute("x2", endX);
    line.setAttribute("y2", endY);
    line.setAttribute("stroke","red");
    line.setAttribute("stroke-width","2");
    overlay.appendChild(line);
}

function update() {
    const nowMs = Date.now();
    const remaining = unpackAtMs - nowMs;

    if (remaining <= 0) {
        cd.textContent = "00:00:000";
        msg.textContent = "ðŸŽ‰ SandÄ±k aÃ§Ä±ldÄ±!";
        setTimeout(() => {
            window.open('', '_self');
            window.close();
        }, 500);
        return;
    }

    const minutes = String(Math.floor(remaining / 60000)).padStart(2,'0');
    const seconds = String(Math.floor((remaining / 1000) % 60)).padStart(2,'0');
    const milliseconds = String(Math.floor(remaining % 1000)).padStart(3,'0');

    cd.textContent = `${minutes}:${seconds}:${milliseconds}`;

    if (edgeMs !== null && !flashDone && remaining <= (edgeMs + leadTime)) {
        flashDone = true;
        triggerSingleFlash();
    }

    drawOverlay();
    requestAnimationFrame(update);
}

window.addEventListener("resize", drawOverlay);
update();
</script>
</body>
</html>
