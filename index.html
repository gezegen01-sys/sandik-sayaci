<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SandÄ±k SayacÄ± + Ã‡izgi ÅžemasÄ±</title>

<style>
body {
  background:#0d1117;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
  font-family:"Segoe UI",sans-serif;
  flex-direction:column;
  position:relative;
}

#countdown { font-size:4em; font-weight:bold; }
#message { margin-top:10px; color:#aaa; }

#edgeBox{
  margin-top:25px;
  padding:15px 25px;
  background:black;
  border-radius:15px;
  display:none;
  font-size:1.6em;
  font-weight:bold;
  align-items:center;
  gap:15px;
  transition:all .05s ease;
  border:2px solid red;
}

#edgeValue{ color:white; }

#earlyText{
  margin-top:40px;
  font-size:.9rem;
  padding:5px 8px;
  border:2px solid red;
  border-radius:5px;
}

#overlay{
  position:absolute;
  top:0;
  left:0;
  pointer-events:none;
}
</style>
</head>
<body>

<div id="countdown">--:--:---</div>
<div id="message">SandÄ±k aÃ§Ä±lmasÄ±na kalan sÃ¼re</div>

<div id="edgeBox">
  <span id="edgeValue">-- ms</span>
</div>

<div id="earlyText">Erken aÃ§Ä±lmasÄ± gereken sÃ¼re</div>

<svg id="overlay"></svg>

<script>
const params = new URLSearchParams(window.location.search);
const timestampParam = Number(params.get("timestamp"));
const unpackAtParam = Number(params.get("unpack_at"));
const edgeParam = params.get("edge");

const cd = document.getElementById("countdown");
const msg = document.getElementById("message");
const edgeBox = document.getElementById("edgeBox");
const edgeValue = document.getElementById("edgeValue");
const earlyText = document.getElementById("earlyText");
const overlay = document.getElementById("overlay");

if(!timestampParam || !unpackAtParam){
  cd.textContent="âŒ Eksik parametre!";
  throw new Error("Eksik parametreler!");
}

history.replaceState({},document.title,window.location.pathname);

function measureEdgeGidisImage(ip,timeout=1800){
  return new Promise(resolve=>{
    const img=new Image();
    const url="https://"+ip+"/probe.png?cb="+Math.random();
    const start=performance.now();
    let ended=false;
    const end=()=>{
      if(ended) return;
      ended=true;
      resolve(performance.now()-start);
    };
    img.onload=end;
    img.onerror=end;
    img.src=url;
    setTimeout(end,timeout);
  });
}

let edgeMs=null;
const leadTime=120;
let flashDone=false;

if(edgeParam){
  (async()=>{
    const ip=edgeParam.replace(":443","");
    const measured=await measureEdgeGidisImage(ip,1800);
    edgeMs=measured;
    edgeValue.textContent=`${Math.round(edgeMs)} ms`;
    edgeBox.style.display="flex";
  })();
}

const unpackAtMs=unpackAtParam*1000;

function triggerSingleFlash(){
  edgeBox.style.background="#ff0000";
  edgeBox.style.boxShadow="0 0 25px 20px #ff0000";
  edgeBox.style.transform="scale(1.2)";
  setTimeout(()=>{
    edgeBox.style.background="black";
    edgeBox.style.boxShadow="none";
    edgeBox.style.transform="scale(1)";
  },100);
}

// ===== Dinamik Ã¼st kutu dÃ¶nen Ã§izgi =====
let animProgress=0;
const lineCount=4;    // 4 kesik Ã§izgi
const lineLength=10;  // kÄ±sa Ã§izgi
const speed=6;        // hÄ±z

function drawOverlay(){
  overlay.innerHTML="";
  overlay.setAttribute("width",window.innerWidth);
  overlay.setAttribute("height",window.innerHeight);

  const earlyRect=earlyText.getBoundingClientRect();
  const edgeRect=edgeBox.getBoundingClientRect();

  // Alt Ã§izgi
  const baseLine=document.createElementNS("http://www.w3.org/2000/svg","line");
  baseLine.setAttribute("x1",earlyRect.left+earlyRect.width/2);
  baseLine.setAttribute("y1",earlyRect.top);
  baseLine.setAttribute("x2",edgeRect.left+edgeRect.width/2);
  baseLine.setAttribute("y2",edgeRect.top+edgeRect.height);
  baseLine.setAttribute("stroke","red");
  baseLine.setAttribute("stroke-width","2");
  overlay.appendChild(baseLine);

  if(edgeBox.style.display==="none") return;

  const msRect=cd.getBoundingClientRect();
  const left=msRect.right-3*(msRect.width/cd.textContent.length)-10;
  const right=msRect.right+10;
  const top=msRect.top-10;
  const bottom=msRect.bottom+10;

  const perimeter=(right-left)*2 + (bottom-top)*2;

  // BaÅŸlangÄ±Ã§: orta kutu saÄŸ ortasÄ±
  const startX=edgeRect.right;
  const startY=edgeRect.top + edgeRect.height/2;

  for(let i=0;i<lineCount;i++){
    const shift=(perimeter/lineCount)*i;
    const progress=(animProgress+shift)%perimeter;

    const path=document.createElementNS("http://www.w3.org/2000/svg","path");

    // Ãœst kutunun dÃ¶rtgeni, baÅŸlangÄ±Ã§ saÄŸ alt kÃ¶ÅŸeden baÅŸlasÄ±n
    path.setAttribute("d",`
      M ${startX} ${startY} 
      L ${right} ${bottom} 
      L ${left} ${bottom} 
      L ${left} ${top} 
      L ${right} ${top} 
      L ${right} ${bottom}
    `);

    path.setAttribute("fill","none");
    path.setAttribute("stroke","red");
    path.setAttribute("stroke-width","3");
    path.setAttribute("stroke-linecap","round");
    path.style.strokeDasharray=`${lineLength} ${perimeter}`;
    path.style.strokeDashoffset=-progress;

    overlay.appendChild(path);
  }

  animProgress += speed;
  if(animProgress>perimeter) animProgress=0;
}

function update(){
  const nowMs=Date.now();
  const remaining=unpackAtMs-nowMs;

  if(remaining<=0){
    cd.textContent="00:00:000";
    msg.textContent="ðŸŽ‰ SandÄ±k aÃ§Ä±ldÄ±!";

    // --- Sayfa kapanma kÄ±smÄ± entegre edildi ---
    setTimeout(()=>{
      window.open('', '_self');
      window.close();
    }, 500);
    // --- BitiÅŸ ---
    return;
  }

  const minutes=String(Math.floor(remaining/60000)).padStart(2,'0');
  const seconds=String(Math.floor((remaining/1000)%60)).padStart(2,'0');
  const milliseconds=String(Math.floor(remaining%1000)).padStart(3,'0');

  cd.textContent=`${minutes}:${seconds}:${milliseconds}`;

  if(edgeMs!==null && !flashDone && remaining<=(edgeMs+leadTime)){
    flashDone=true;
    triggerSingleFlash();
  }

  drawOverlay();
  requestAnimationFrame(update);
}

window.addEventListener("resize",drawOverlay);
update();
</script>
</body>
</html>
